<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' https://cdn.jsdelivr.net https://checkout.razorpay.com 'unsafe-inline';
    style-src 'self' https://cdn.jsdelivr.net https://fonts.googleapis.com 'unsafe-inline';
    img-src 'self' data: https:;
    font-src 'self' https://cdn.jsdelivr.net https://fonts.gstatic.com;
    connect-src 'self' https://your-api-domain.com https://api.razorpay.com https://lumberjack.razorpay.com https://cdn.jsdelivr.net;
    frame-src https://checkout.razorpay.com https://api.razorpay.com;
  ">
  <title>The Local Basket - Premium Local Products</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.4/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90' fill='%23C5A47E'>LB</text></svg>">
</head>
<body>
  
  
    <!-- Navbar -->
<nav class="navbar navbar-light fixed-top bg-white shadow-sm py-2">
  <div class="container-fluid d-flex align-items-center justify-content-between">

    <!-- Brand with Logo -->
    <a class="navbar-brand me-2" href="index.html">
      <img src="images/logo.PNG" alt="The Local Basket" 
           style="height: 35px; max-height: 8vw;" class="d-inline-block align-top">
    </a>

    <!-- Search Bar -->
    <div class="mx-2 flex-shrink-1" style="flex: 0 1 62%;">
      <input type="text" id="searchInput" 
             class="form-control rounded shadow-sm w-100" 
             placeholder="search products...">
    </div>

    <!-- Right side: Account & Cart -->
    <div class="d-flex align-items-center flex-shrink-0 ms-2">

      <!-- Account -->
      <a class="nav-link text-dark me-2 d-flex align-items-center" href="Login.html">
        <i class="bi bi-person-circle fs-5"></i>
      </a>

      <!-- Cart -->
      <div class="position-relative">
        <button class="btn btn-light openCartBtn shadow-sm">
          <i class="bi bi-cart3 fs-5"></i>
          <span class="position-absolute top-0 start-100 translate-middle 
                       badge rounded-pill bg-danger cart-count">0</span>
        </button>
      </div>

    </div>
    
  </div>
</nav>



  <!-- Main Content -->
  <div class="container mt-3 pt-1">
    <!-- Hero Section -->
    <section class="hero-section mb-4">
      <video autoplay loop muted playsinline class="w-100 rounded">
        <source src="images/offer.mp4" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    </section>
   
    <!-- Featured Products -->
    <div class="category-banner mb-3">
      <h3 class="text-center">
        <img src="https://cdn-icons-png.flaticon.com/512/5619/5619269.png" alt="Stationary">
        Featured Products
        <img src="https://cdn-icons-png.flaticon.com/512/5619/5619269.png" alt="Stationary">
      </h3>
      <p class="text-center small">All rates listed below are already offered at a 50% discount.</p>
    </div>

    <div class="products-grid">
      <!-- Products will be injected here -->
    </div>
  </div>

  <!-- ================== Image Modal ================== -->
  <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content bg-transparent border-0 shadow-none">
        <button type="button" class="btn-close ms-auto me-2 mt-2" data-bs-dismiss="modal"></button>
        <img id="modalImage" src="" class="img-fluid rounded shadow" alt="Product Preview">
      </div>
    </div>
  </div>

  <!-- ================== Cart Modal ================== -->
  <div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-cart3 me-2"></i>Your Shopping Cart</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="cartBody"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Continue Shopping</button>
          <button type="button" class="btn btn-success" id="checkoutBtn">Place Order & Pay</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ================== Footer ================== -->
<footer class="footer bg-light pt-5 mt-5">
  <div class="container">
    <div class="row">

      <!-- About Section -->
      <div class="col-md-4 mb-4 mb-md-0">
        <h5>The Local Basket</h5>
        <p>Your premier destination for locally sourced, high-quality products. Supporting local businesses and artisans since 2025.</p>
        <div class="d-flex gap-3 mt-3">
          <a href="#" class="text-dark fs-5"><i class="bi bi-facebook"></i></a>
          <a href="https://www.instagram.com/thelocal_basket25" target="_blank" class="text-dark fs-5"><i class="bi bi-instagram"></i></a>
          <a href="https://wa.me/+919609010193" target="_blank" class="text-dark fs-5"><i class="bi bi-whatsapp"></i></a>
        </div>
      </div>

      <!-- Help Section -->
      <div class="col-md-2 mb-4 mb-md-0">
        <h5>Help</h5>
       <ul class="list-unstyled">
            <li><a href="FAQs.html" target="_blank" class="text-decoration-none" style="color: white;">FAQs</a></li>
            <li><a href="shipping.html" target="_blank" class="text-decoration-none" style="color: white;">Shipping</a></li>
            <li><a href="return.html" target="_blank" class="text-decoration-none" style="color: white;">Returns</a></li>
            <li><a href="contactus.html" target="_blank" class="text-decoration-none" style="color: white;">Contact us</a></li>
        </ul>

      </div>

    </div>

        <div class="col-12 text-center" style="color: #f8f9fa;">
             &copy; 2025 The Local Basket. All rights reserved.
        </div>

  </div>
</footer>

  <!-- ================== Scripts ================== -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.4/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const productsGrid = document.querySelector(".products-grid");
      const cartModalEl = document.getElementById("cartModal");
      const cartModal = new bootstrap.Modal(cartModalEl);
      const cartBody = document.getElementById("cartBody");
      const cartCountSpans = document.querySelectorAll(".cart-count");
      const checkoutBtn = document.getElementById("checkoutBtn");
      let cart = [];

      // ---------- Helper Functions ----------
      function updateCartCount() {
        const count = cart.reduce((sum, i) => sum + i.qty, 0);
        cartCountSpans.forEach(span => span.textContent = count);
      }

      function removeFromCart(id) {
        cart = cart.filter(i => i.id !== id);
        updateCartCount();
        renderCart();
      }

      function changeQty(id, delta) {
        const item = cart.find(i => i.id === id);
        if (!item) return;
        item.qty += delta;
        if (item.qty < 1) removeFromCart(id);
        else { renderCart(); updateCartCount(); }
      }

      function renderCart() {
        cartBody.innerHTML = '';
        if (cart.length === 0) {
          cartBody.innerHTML = `
            <div class="text-center py-5">
              <i class="bi bi-cart-x display-4 text-muted"></i>
              <h4>Your cart is empty</h4>
              <p>Add some products to your cart</p>
            </div>`;
          return;
        }

        let total = 0;
        cart.forEach(item => total += item.price * item.qty);

        cart.forEach(item => {
          const div = document.createElement('div');
          div.className = "cart-item border-bottom py-2";
          div.innerHTML = `
            <div class="row align-items-center">
              <div class="col-2"><img src="${item.img}" alt="${item.name}" class="img-fluid rounded"></div>
              <div class="col-4"><strong>${item.name}</strong><p class="text-muted small">₹${item.price}</p></div>
              <div class="col-3 d-flex align-items-center">
                <button class="btn btn-sm btn-outline-secondary quantity-btn decrease" data-id="${item.id}">-</button>
                <span class="mx-2">${item.qty}</span>
                <button class="btn btn-sm btn-outline-secondary quantity-btn increase" data-id="${item.id}">+</button>
              </div>
              <div class="col-2"><strong>₹${item.price * item.qty}</strong></div>
              <div class="col-1 text-end">
                <button class="btn btn-sm btn-danger remove-item" data-id="${item.id}"><i class="bi bi-trash"></i></button>
              </div>
            </div>`;
          cartBody.appendChild(div);
        });

        const shipping = 80;
        const grandTotal = total + shipping;

        cartBody.innerHTML += `
          <div class="text-end mt-3">
            <h5>Subtotal: ₹${total}</h5>
            <h5>Shipping: ₹${shipping}</h5>
            <h4>Total: ₹${grandTotal}</h4>
          </div>
          <div class="mt-4">
            <h5><i class="bi bi-truck me-2"></i>Shipping Information</h5>
            <div class="mb-3"><input type="text" class="form-control shipping-name" placeholder="Full Name" required></div>
            <div class="mb-3"><input type="email" class="form-control shipping-email" placeholder="Email" required></div>
            <div class="mb-3"><textarea class="form-control shipping-address" placeholder="Full Address with PIN" rows="2" required></textarea></div>
            <div class="mb-3"><input type="tel" class="form-control contact-number" placeholder="Contact Number" required maxlength="10"></div>
          </div>`;

        // Event delegation for quantity and remove
        cartBody.querySelectorAll(".increase").forEach(btn => btn.addEventListener("click", () => changeQty(btn.dataset.id, 1)));
        cartBody.querySelectorAll(".decrease").forEach(btn => btn.addEventListener("click", () => changeQty(btn.dataset.id, -1)));
        cartBody.querySelectorAll(".remove-item").forEach(btn => btn.addEventListener("click", () => removeFromCart(btn.dataset.id)));
      }

     // ---------- Fetch Products ----------
      try {
        const res = await fetch("/api/products");
        const data = await res.json();
        if (!data.success) throw new Error("Failed to fetch products");

        productsGrid.innerHTML = "";

        data.products.forEach(product => {
          const div = document.createElement("div");
          div.className = "product-card";
          div.dataset.id = product.id;

          // Use placeholder image + lazy loading
          div.innerHTML = `
            <img src="images/placeholder.jpg" data-src="${product.image}" class="product-img w-100 rounded" alt="${product.name}" loading="lazy">
            <div class="product-body p-2">
                <h5 class="product-title">${product.name}</h5>
                <p class="product-description small">${product.description}</p>
                <div class="product-price fw-bold">₹${product.price}</div>
                <button class="btn btn-success btn-add-cart w-100 mt-2">
                  <i class="bi bi-cart-plus me-1"></i> Add to Cart
                </button>
            </div>
          `;

          productsGrid.appendChild(div);
        });

        // ---------- Lazy Load Images ----------
        const lazyImages = document.querySelectorAll("img[data-src]");
        const observer = new IntersectionObserver(entries => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target;
              img.src = img.dataset.src;
              img.removeAttribute("data-src");
              observer.unobserve(img);
            }
          });
        });
        lazyImages.forEach(img => observer.observe(img));

        // ---------- Image Modal ----------
        productsGrid.querySelectorAll(".product-img").forEach(img => {
          img.addEventListener("click", () => {
            const imageModal = new bootstrap.Modal(document.getElementById("imageModal"));
            const modalImage = document.getElementById("modalImage");
            modalImage.src = img.src;
            modalImage.alt = img.alt;
            imageModal.show();
          });
        });

        // ---------- Filter/Search ----------
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', () => {
          const query = searchInput.value.toLowerCase();
          const productCards = document.querySelectorAll('.product-card');

          productCards.forEach(card => {
            const title = card.querySelector('.product-title').textContent.toLowerCase();
            const description = card.querySelector('.product-description')?.textContent.toLowerCase() || '';

            card.style.display = (title.includes(query) || description.includes(query)) ? 'flex' : 'none';
          });
        });

        // ---------- Add to Cart ----------
        productsGrid.querySelectorAll(".btn-add-cart").forEach(btn => {
          btn.addEventListener("click", () => {
            const parent = btn.closest(".product-card");
            const id = parent.dataset.id;
            const name = parent.querySelector(".product-title").textContent;
            const price = Number(parent.querySelector(".product-price").textContent.replace("₹", ""));
            const img = parent.querySelector("img").src;

            const existing = cart.find(i => i.id === id);
            if (existing) existing.qty++;
            else cart.push({ id, name, price, img, qty: 1 });

            updateCartCount();
            renderCart();
            cartModal.show();
          });
        });

        console.log("Products loaded. From cache:", data.cached);

      } catch (err) {
        console.error(err);
        productsGrid.innerHTML = "<p class='text-danger'>Failed to load products. Please try again later.</p>";
      }


      // ---------- Open Cart ----------
      document.querySelectorAll(".openCartBtn").forEach(btn => btn.addEventListener("click", () => cartModal.show()));

      // ---------- Checkout ----------
      checkoutBtn.addEventListener("click", async () => {
        if (cart.length === 0){ alert("Cart is empty"); return; }

        const name = document.querySelector('.shipping-name').value;
        const email = document.querySelector('.shipping-email').value;
        const address = document.querySelector('.shipping-address').value;
        const phone = document.querySelector('.contact-number').value;

        if (!name || !email || !address || !phone){ alert("Fill all shipping details"); return; }

        const totalAmount = cart.reduce((sum,i)=>sum+i.price*i.qty,0)+80;

        try {
          const orderRes = await fetch('/create-razorpay-order', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ amount: totalAmount, currency: "INR" })
          });
          const orderData = await orderRes.json();
          if(!orderData.success){ alert("Failed to create payment order"); return; }

          const options = {
            key: orderData.order.key_id,
            amount: orderData.order.amount,
            currency: orderData.order.currency,
            name: "The Local Basket",
            description: "Order Payment",
            order_id: orderData.order.id,
            handler: async function(response){
              const orderDetails = { items: cart, shipping:{ name,email,address,phone }, paymentId: response.razorpay_payment_id, grandTotal: totalAmount };
              try{
                const res = await fetch('/send-order', {
                  method:'POST',
                  headers:{'Content-Type':'application/json'},
                  body: JSON.stringify(orderDetails)
                });
                const result = await res.json();
                if(result.success){ alert("Order placed successfully! Check your email."); cart=[]; updateCartCount(); cartModal.hide(); renderCart(); }
                else alert("Failed to place order.");
              }catch(err){ console.error(err); alert("Error sending order email"); }
            },
            prefill:{ name,email,contact:phone },
            theme:{ color:"#198754" }
          };
          const rzp = new Razorpay(options);
          rzp.open();
        }catch(err){ console.error(err); alert("Error initiating payment"); }
      });

    });
  </script>
</body>
</html>
